<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìû Dashboard Call Center - Tiempo Real</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --accent-blue: #0ea5e9;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(14, 165, 233, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo span {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 50px;
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--card-accent), transparent);
        }

        .stat-card.blue { --card-accent: var(--accent-blue); }
        .stat-card.green { --card-accent: var(--accent-green); }
        .stat-card.yellow { --card-accent: var(--accent-yellow); }
        .stat-card.purple { --card-accent: var(--accent-purple); }
        .stat-card.red { --card-accent: var(--accent-red); }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-card.blue .stat-icon { background: rgba(14, 165, 233, 0.2); }
        .stat-card.green .stat-icon { background: rgba(16, 185, 129, 0.2); }
        .stat-card.yellow .stat-icon { background: rgba(245, 158, 11, 0.2); }
        .stat-card.purple .stat-icon { background: rgba(139, 92, 246, 0.2); }
        .stat-card.red .stat-icon { background: rgba(239, 68, 68, 0.2); }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-card.blue .stat-value { color: var(--accent-blue); }
        .stat-card.green .stat-value { color: var(--accent-green); }
        .stat-card.yellow .stat-value { color: var(--accent-yellow); }
        .stat-card.purple .stat-value { color: var(--accent-purple); }
        .stat-card.red .stat-value { color: var(--accent-red); }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .stat-trend.up { color: var(--accent-green); }
        .stat-trend.down { color: var(--accent-red); }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-body {
            padding: 24px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Queue List */
        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .queue-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .queue-item:hover {
            border-color: var(--accent-blue);
            transform: translateX(5px);
        }

        .queue-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .queue-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .queue-status.good { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
        .queue-status.warning { background: var(--accent-yellow); box-shadow: 0 0 10px var(--accent-yellow); }
        .queue-status.critical { background: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }

        .queue-name {
            font-weight: 600;
        }

        .queue-metrics {
            display: flex;
            gap: 20px;
        }

        .queue-metric {
            text-align: right;
        }

        .queue-metric-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .queue-metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Alerts */
        .alerts-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alert {
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert.anomaly {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--accent-red);
        }

        .alert.suggestion {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--accent-green);
        }

        .alert.prediction {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--accent-purple);
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .alert-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Prediction Panel */
        .prediction-panel {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(14, 165, 233, 0.15));
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .prediction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
        }

        .prediction-item {
            text-align: center;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prediction-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-purple);
        }

        .prediction-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Activity Log */
        .activity-log {
            height: 200px;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .log-message {
            word-break: break-word;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .number-animate {
            transition: all 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .prediction-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .prediction-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .queue-metrics {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-blue);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üìû</div>
                <div>
                    <h1>Call Center Dashboard</h1>
                    <span>Monitoreo en Tiempo Real</span>
                </div>
            </div>
            <div class="status-badge">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="connectionText">Desconectado</span>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon">üìä</div>
                <div class="stat-label">Total Colas</div>
                <div class="stat-value" id="totalQueues">0</div>
                <div class="stat-trend up">
                    <span>‚Üë</span>
                    <span>Activas</span>
                </div>
            </div>
            <div class="stat-card yellow">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-label">En Espera</div>
                <div class="stat-value" id="totalWaiting">0</div>
                <div class="stat-trend" id="waitingTrend">
                    <span>‚Äî</span>
                    <span>Estable</span>
                </div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">üë§</div>
                <div class="stat-label">Agentes Disponibles</div>
                <div class="stat-value" id="totalAvailable">0</div>
                <div class="stat-trend up">
                    <span>‚Üë</span>
                    <span>Online</span>
                </div>
            </div>
            <div class="stat-card blue">
                <div class="stat-icon">üìû</div>
                <div class="stat-label">Agentes Ocupados</div>
                <div class="stat-value" id="totalBusy">0</div>
                <div class="stat-trend">
                    <span>üîÑ</span>
                    <span>En llamada</span>
                </div>
            </div>
            <div class="stat-card purple">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Completadas</div>
                <div class="stat-value" id="totalCompleted">0</div>
                <div class="stat-trend">
                    <span>üìä</span>
                    <span>Total</span>
                </div>
            </div>
            <div class="stat-card red">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-label">Abandonadas</div>
                <div class="stat-value" id="totalAbandoned">0</div>
                <div class="stat-trend">
                    <span>‚ö†Ô∏è</span>
                    <span>Perdidas</span>
                </div>
            </div>
        </div>

        <!-- Prediction Panel -->
        <div class="prediction-panel" id="predictionPanel" style="display: none;">
            <div class="prediction-header">
                <span style="font-size: 1.5rem;">üîÆ</span>
                <h3>Predicci√≥n IA - Pr√≥ximos 10 minutos</h3>
                <span id="predConfidence" style="font-size: 0.8rem; margin-left: auto; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.2);">--</span>
            </div>
            <div class="prediction-grid">
                <div class="prediction-item">
                    <div class="prediction-value" id="predCallVolume">--</div>
                    <div class="prediction-label">Llamadas Esperadas</div>
                </div>
                <div class="prediction-item">
                    <div class="prediction-value" id="predWaitTime">--</div>
                    <div class="prediction-label">Tiempo Espera (s)</div>
                </div>
                <div class="prediction-item">
                    <div class="prediction-value" id="predAgentsNeeded">--</div>
                    <div class="prediction-label">Agentes Disponibles</div>
                </div>
                <div class="prediction-item">
                    <div class="prediction-value" id="predTrend">--</div>
                    <div class="prediction-label">Tendencia</div>
                </div>
                <div class="prediction-item">
                    <div class="prediction-value" id="predAbandonRate">--</div>
                    <div class="prediction-label">Tasa Abandono %</div>
                </div>
                <div class="prediction-item">
                    <div class="prediction-value" id="predSamples">--</div>
                    <div class="prediction-label">Muestras IA</div>
                </div>
            </div>
            <div id="predRecommendation" style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.9rem; text-align: center;">
                Esperando predicci√≥n...
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Chart Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üìà</span>
                        <span>Actividad en Tiempo Real</span>
                    </div>
                    <div class="controls">
                        <button class="btn btn-secondary" onclick="requestPrediction()">
                            üîÆ Predicci√≥n Cr√≠tica
                        </button>
                        <button class="btn btn-secondary" onclick="requestAllPredictions()">
                            üìä Todas las Colas
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Queues Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üìã</span>
                        <span>Estado de Colas</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="queue-list" id="queueList">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="main-grid">
            <!-- Alerts Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üîî</span>
                        <span>Alertas y Sugerencias</span>
                    </div>
                    <button class="btn btn-secondary" onclick="clearAlerts()">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                <div class="card-body">
                    <div class="alerts-container" id="alertsContainer">
                        <div class="alert suggestion">
                            <span class="alert-icon">üí°</span>
                            <div class="alert-content">
                                <div class="alert-title">Esperando conexi√≥n...</div>
                                <div class="alert-message">Conectando al servidor WebSocket</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üìù</span>
                        <span>Log de Actividad</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="activity-log" id="activityLog">
                        <div class="log-entry">
                            <span class="log-time">[--:--:--]</span>
                            <span class="log-message">Iniciando dashboard...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>üöÄ Dashboard Call Center v2.0 | Actualizaci√≥n en tiempo real via WebSocket</p>
        </footer>
    </div>

    <script>
        // Configuration - Conectar al proxy local que hace logging
        const WS_URL = `ws://${window.location.host}`;
        
        // State
        let ws = null;
        let chartData = {
            waiting: [],
            available: [],
            labels: []
        };
        let alerts = [];
        let mainChart = null;
        let currentQueues = []; // Guardar las colas actuales para las predicciones
        
        // DOM Elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const totalQueues = document.getElementById('totalQueues');
        const totalWaiting = document.getElementById('totalWaiting');
        const totalAvailable = document.getElementById('totalAvailable');
        const totalBusyEl = document.getElementById('totalBusy');
        const totalCompletedEl = document.getElementById('totalCompleted');
        const totalAbandonedEl = document.getElementById('totalAbandoned');
        const queueList = document.getElementById('queueList');
        const alertsContainer = document.getElementById('alertsContainer');
        const activityLog = document.getElementById('activityLog');
        const predictionPanel = document.getElementById('predictionPanel');
        
        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'En Espera',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#f59e0b'
                        },
                        {
                            label: 'Agentes Disponibles',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        },
                        {
                            label: 'Agentes Ocupados',
                            data: [],
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#0ea5e9'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#94a3b8',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a2e',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });
        }
        
        // WebSocket Connection
        function connectWebSocket() {
            addLog('Conectando a ' + WS_URL + '...');
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                connectionStatus.classList.add('connected');
                connectionText.textContent = 'Conectado';
                addLog('‚úÖ Conexi√≥n establecida');
                addAlert('suggestion', 'Conectado', 'Conexi√≥n WebSocket establecida exitosamente');
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    addLog('‚ùå Error parseando mensaje: ' + e.message);
                }
            };
            
            ws.onerror = (error) => {
                addLog('‚ùå Error de conexi√≥n');
                addAlert('anomaly', 'Error de Conexi√≥n', 'No se pudo conectar al servidor WebSocket');
            };
            
            ws.onclose = () => {
                connectionStatus.classList.remove('connected');
                connectionText.textContent = 'Desconectado';
                addLog('üîå Conexi√≥n cerrada. Reconectando en 5s...');
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // Message Handler
        function handleMessage(message) {
            addLog('üì® Recibido: ' + message.type);
            
            switch(message.type) {
                case 'initial_data':
                    handleInitialData(message.data);
                    break;
                case 'queue_update':
                    handleQueueUpdate(message.data);
                    break;
                case 'prediction':
                    handlePrediction(message.data);
                    break;
                default:
                    addLog('‚ö†Ô∏è Tipo de mensaje desconocido: ' + message.type);
            }
        }
        
        // Handle Initial Data
        function handleInitialData(data) {
            console.log('üìã Initial Data:', data);
            
            animateNumber(totalQueues, data.total_queues || 0);
            animateNumber(totalWaiting, data.total_waiting || 0);
            animateNumber(totalAvailable, data.total_available || 0);
            animateNumber(totalBusyEl, data.total_busy || 0);
            
            // queues es un ARRAY
            if (data.queues && Array.isArray(data.queues)) {
                currentQueues = data.queues; // Guardar para predicciones
                let totalCompleted = 0;
                let totalAbandoned = 0;
                
                data.queues.forEach(q => {
                    totalCompleted += q.completed || 0;
                    totalAbandoned += q.abandoned || 0;
                });
                
                animateNumber(totalCompletedEl, totalCompleted);
                animateNumber(totalAbandonedEl, totalAbandoned);
                
                updateQueueList(data.queues);
                updateChart(data.total_waiting || 0, data.total_available || 0, data.total_busy || 0);
            }
            
            addAlert('suggestion', 'Datos Iniciales', 
                `${data.total_queues} colas, ${data.total_waiting} en espera, ${data.total_available} agentes disponibles, ${data.total_busy} ocupados`);
        }
        
        // Handle Queue Update
        function handleQueueUpdate(data) {
            console.log('üìä Queue Update Data:', data);
            
            // Los datos vienen directo de data (total_queues, total_waiting, etc.)
            const totalWait = data.total_waiting || 0;
            const totalAvail = data.total_available || 0;
            const queueCount = data.total_queues || 0;
            const totalBusy = data.total_busy || 0;
            
            animateNumber(totalQueues, queueCount);
            animateNumber(totalWaiting, totalWait);
            animateNumber(totalAvailable, totalAvail);
            animateNumber(totalBusyEl, totalBusy);
            
            // Calcular totales de completadas y abandonadas
            let totalCompleted = 0;
            let totalAbandoned = 0;
            
            // queues es un ARRAY, no un objeto
            if (data.queues && Array.isArray(data.queues)) {
                currentQueues = data.queues; // Guardar para predicciones
                data.queues.forEach(q => {
                    totalCompleted += q.completed || 0;
                    totalAbandoned += q.abandoned || 0;
                });
                
                animateNumber(totalCompletedEl, totalCompleted);
                animateNumber(totalAbandonedEl, totalAbandoned);
                
                updateQueueList(data.queues);
                updateChart(totalWait, totalAvail, totalBusy);
            }
            
            // Handle analytics
            if (data.analytics) {
                if (data.analytics.anomalies && data.analytics.anomalies.length > 0) {
                    data.analytics.anomalies.forEach(anomaly => {
                        // anomaly es un objeto con: queue, type, severity, message, current_value, expected_value
                        const title = `‚ö†Ô∏è ${anomaly.queue || 'Sistema'} - ${anomaly.severity === 'critical' ? 'üî¥ CR√çTICO' : 'üü° Advertencia'}`;
                        const message = anomaly.message || JSON.stringify(anomaly);
                        addAlert('anomaly', title, message);
                    });
                }
                
                if (data.analytics.suggestions && data.analytics.suggestions.length > 0) {
                    data.analytics.suggestions.forEach(suggestion => {
                        // suggestion puede ser un string o un objeto
                        const message = typeof suggestion === 'string' ? suggestion : (suggestion.message || JSON.stringify(suggestion));
                        addAlert('suggestion', 'Sugerencia', message);
                    });
                }
            }
        }
        
        // Handle Prediction
        function handlePrediction(data) {
            console.log('üîÆ Prediction Data:', data);
            predictionPanel.style.display = 'block';
            
            const queueName = data.queue || 'General';
            
            // Verificar si hay mensaje de error o datos insuficientes
            if (data.message && data.confidence === 'none') {
                // El servidor devuelve un mensaje cuando no hay datos suficientes
                document.getElementById('predCallVolume').textContent = '‚è≥';
                document.getElementById('predWaitTime').textContent = '‚è≥';
                document.getElementById('predAgentsNeeded').textContent = '‚è≥';
                document.getElementById('predTrend').textContent = '‚è≥';
                document.getElementById('predAbandonRate').textContent = '‚è≥';
                document.getElementById('predSamples').textContent = '0';
                document.getElementById('predConfidence').textContent = '‚è≥ Recopilando datos...';
                document.getElementById('predRecommendation').innerHTML = `<span style="color: #ffd700;">üìä ${data.message}</span>`;
                
                addAlert('prediction', `üîÆ ${queueName}: Iniciando`, data.message);
                addLog(`üîÆ ${queueName}: ${data.message}`);
                return;
            }
            
            // Campos del servidor cuando hay datos:
            const predictedCalls = data.predicted_calls_waiting ?? '--';
            const predictedHold = data.predicted_hold_time ?? '--';
            const predictedAgents = data.predicted_available_agents ?? '--';
            const trend = data.trend || 'stable';
            const agentTrend = data.agent_trend || 'stable';
            const alertLevel = data.alert_level || 'normal';
            const recommendation = data.recommendation || 'Sin recomendaci√≥n';
            const confidence = data.confidence || data.prediction_confidence || 'low';
            const basedOnSamples = data.based_on_samples || 0;
            const abandonRate = data.abandon_rate ?? '--';
            const currentCalls = data.current_calls ?? '--';
            const currentAgents = data.current_agents ?? '--';
            
            document.getElementById('predCallVolume').textContent = predictedCalls;
            document.getElementById('predWaitTime').textContent = predictedHold;
            document.getElementById('predAgentsNeeded').textContent = predictedAgents;
            document.getElementById('predSamples').textContent = basedOnSamples;
            document.getElementById('predAbandonRate').textContent = abandonRate + '%';
            
            // Mostrar tendencia con icono
            const trendIcon = trend === 'increasing' ? 'üìà' : trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
            document.getElementById('predTrend').textContent = trendIcon;
            
            // Mostrar confianza con color
            const confColors = {high: '#4ade80', medium: '#fbbf24', low: '#f87171', very_low: '#ef4444'};
            const confLabels = {high: 'üéØ Alta', medium: 'üìä Media', low: '‚ö†Ô∏è Baja', very_low: 'üîÑ Muy Baja'};
            document.getElementById('predConfidence').textContent = confLabels[confidence] || confidence;
            document.getElementById('predConfidence').style.background = confColors[confidence] || '#666';
            
            // Mostrar recomendaci√≥n con estilo seg√∫n alerta
            const alertColors = {high: '#f87171', medium: '#fbbf24', normal: '#4ade80', unknown: '#9ca3af'};
            const alertIcon = alertLevel === 'high' ? 'üî¥' : alertLevel === 'medium' ? 'üü°' : 'üü¢';
            document.getElementById('predRecommendation').innerHTML = 
                `<span style="color: ${alertColors[alertLevel]};">${alertIcon} ${recommendation}</span><br>
                 <small style="opacity: 0.8;">Actual: ${currentCalls} llamadas | ${currentAgents} agentes</small>`;
            
            // Actualizar el t√≠tulo del panel con la cola
            const predHeader = document.querySelector('.prediction-header h3');
            if (predHeader) {
                predHeader.textContent = `Predicci√≥n IA: ${queueName} - Pr√≥ximos ${data.minutes_ahead || 10} min`;
            }
            
            addAlert('prediction', `üîÆ Predicci√≥n: ${queueName} ${alertIcon}`, 
                `${recommendation} | Confianza: ${confLabels[confidence] || confidence} (${basedOnSamples} muestras)`);
            
            addLog(`üîÆ ${queueName}: ${predictedCalls} llamadas, ${predictedHold}s espera, ${abandonRate}% abandono`);
        }
        
        // Update Queue List - queues es un ARRAY de objetos
        function updateQueueList(queues) {
            console.log('üìã Actualizando lista de colas:', queues);
            let html = '';
            
            // Iterar sobre el array de colas
            for (const queue of queues) {
                const name = queue.name || 'Sin nombre';
                const waiting = queue.calls_waiting || 0;
                const members = queue.members || {};
                const available = members.available || 0;
                const busy = members.busy || 0;
                const paused = members.paused || 0;
                const totalMembers = members.total || 0;
                const completed = queue.completed || 0;
                const abandoned = queue.abandoned || 0;
                const holdTime = queue.hold_time || 0;
                const serviceLevel = queue.service_level || 0;
                
                // Status basado en llamadas en espera
                let status = 'good';
                if (waiting > 10) status = 'critical';
                else if (waiting > 5) status = 'warning';
                
                // Tambi√©n marcar cr√≠tico si no hay agentes disponibles pero hay espera
                if (waiting > 0 && available === 0) status = 'critical';
                
                html += `
                    <div class="queue-item fade-in">
                        <div class="queue-info">
                            <div class="queue-status ${status}"></div>
                            <div>
                                <div class="queue-name">${name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary)">
                                    SL: ${(serviceLevel * 100).toFixed(1)}% | Hold: ${holdTime}s
                                </div>
                            </div>
                        </div>
                        <div class="queue-metrics">
                            <div class="queue-metric">
                                <div class="queue-metric-value" style="color: #f59e0b">${waiting}</div>
                                <div class="queue-metric-label">En Espera</div>
                            </div>
                            <div class="queue-metric">
                                <div class="queue-metric-value" style="color: #10b981">${available}</div>
                                <div class="queue-metric-label">Disponibles</div>
                            </div>
                            <div class="queue-metric">
                                <div class="queue-metric-value" style="color: #0ea5e9">${busy}</div>
                                <div class="queue-metric-label">Ocupados</div>
                            </div>
                            <div class="queue-metric">
                                <div class="queue-metric-value" style="color: #8b5cf6">${paused}</div>
                                <div class="queue-metric-label">Pausados</div>
                            </div>
                            <div class="queue-metric">
                                <div class="queue-metric-value" style="color: #22c55e">${completed}</div>
                                <div class="queue-metric-label">Completadas</div>
                            </div>
                            <div class="queue-metric">
                                <div class="queue-metric-value" style="color: #ef4444">${abandoned}</div>
                                <div class="queue-metric-label">Abandonadas</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (html === '' || queues.length === 0) {
                html = `
                    <div class="alert suggestion">
                        <span class="alert-icon">üì≠</span>
                        <div class="alert-content">
                            <div class="alert-title">Sin datos de colas</div>
                            <div class="alert-message">Esperando datos del servidor...</div>
                        </div>
                    </div>
                `;
            }
            
            queueList.innerHTML = html;
        }
        
        // Update Chart
        function updateChart(waiting, available, busy = 0) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // Keep last 20 data points
            if (mainChart.data.labels.length >= 20) {
                mainChart.data.labels.shift();
                mainChart.data.datasets[0].data.shift();
                mainChart.data.datasets[1].data.shift();
                mainChart.data.datasets[2].data.shift();
            }
            
            mainChart.data.labels.push(timeLabel);
            mainChart.data.datasets[0].data.push(waiting);
            mainChart.data.datasets[1].data.push(available);
            mainChart.data.datasets[2].data.push(busy);
            
            mainChart.update('none');
        }
        
        // Add Alert
        function addAlert(type, title, message) {
            const icons = {
                anomaly: '‚ö†Ô∏è',
                suggestion: 'üí°',
                prediction: 'üîÆ'
            };
            
            const time = new Date().toLocaleTimeString('es-ES');
            
            const alertHtml = `
                <div class="alert ${type}">
                    <span class="alert-icon">${icons[type]}</span>
                    <div class="alert-content">
                        <div class="alert-title">${title}</div>
                        <div class="alert-message">${message}</div>
                    </div>
                    <div class="alert-time">${time}</div>
                </div>
            `;
            
            alertsContainer.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Keep only last 20 alerts
            while (alertsContainer.children.length > 20) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }
        
        // Add Log Entry
        function addLog(message) {
            const time = new Date().toLocaleTimeString('es-ES');
            const logHtml = `
                <div class="log-entry">
                    <span class="log-time">[${time}]</span>
                    <span class="log-message">${message}</span>
                </div>
            `;
            
            activityLog.insertAdjacentHTML('beforeend', logHtml);
            activityLog.scrollTop = activityLog.scrollHeight;
            
            // Keep only last 100 log entries
            while (activityLog.children.length > 100) {
                activityLog.removeChild(activityLog.firstChild);
            }
        }
        
        // Animate Number
        function animateNumber(element, newValue) {
            const currentValue = parseInt(element.textContent) || 0;
            const diff = newValue - currentValue;
            const steps = 20;
            const stepValue = diff / steps;
            let step = 0;
            
            const interval = setInterval(() => {
                step++;
                if (step >= steps) {
                    element.textContent = newValue;
                    clearInterval(interval);
                } else {
                    element.textContent = Math.round(currentValue + (stepValue * step));
                }
            }, 25);
        }
        
        // Clear Alerts
        function clearAlerts() {
            alertsContainer.innerHTML = `
                <div class="alert suggestion">
                    <span class="alert-icon">‚úÖ</span>
                    <div class="alert-content">
                        <div class="alert-title">Alertas limpiadas</div>
                        <div class="alert-message">Todas las alertas han sido descartadas</div>
                    </div>
                </div>
            `;
            addLog('üóëÔ∏è Alertas limpiadas');
        }
        
        // Request Prediction - Selecciona autom√°ticamente la cola m√°s cr√≠tica
        function requestPrediction() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Encontrar la cola m√°s cr√≠tica
                let targetQueue = null;
                
                if (currentQueues && currentQueues.length > 0) {
                    // Ordenar por criticidad: m√°s llamadas en espera + menos agentes disponibles
                    const sortedQueues = [...currentQueues].sort((a, b) => {
                        const aWaiting = a.calls_waiting || 0;
                        const bWaiting = b.calls_waiting || 0;
                        const aAvailable = a.members?.available || 0;
                        const bAvailable = b.members?.available || 0;
                        
                        // Score de criticidad: m√°s espera y menos disponibles = m√°s cr√≠tico
                        const aScore = aWaiting * 10 - aAvailable;
                        const bScore = bWaiting * 10 - bAvailable;
                        
                        return bScore - aScore; // Mayor score primero
                    });
                    
                    targetQueue = sortedQueues[0].name;
                    
                    const waiting = sortedQueues[0].calls_waiting || 0;
                    const available = sortedQueues[0].members?.available || 0;
                    addLog(`üéØ Cola m√°s cr√≠tica: ${targetQueue} (${waiting} espera, ${available} disponibles)`);
                } else {
                    // Si no hay colas, usar un nombre por defecto
                    targetQueue = 'ventas';
                    addLog('‚ö†Ô∏è No hay colas cargadas, usando cola por defecto');
                }
                
                ws.send(JSON.stringify({
                    type: 'get_prediction',
                    queue_name: targetQueue,
                    minutes_ahead: 10
                }));
                
                addLog(`üîÆ Solicitando predicci√≥n para: ${targetQueue}...`);
                addAlert('prediction', `Predicci√≥n Solicitada: ${targetQueue}`, 'Esperando respuesta del servidor de IA...');
            } else {
                addAlert('anomaly', 'Error', 'No hay conexi√≥n con el servidor');
            }
        }
        
        // Request Prediction for ALL queues
        function requestAllPredictions() {
            if (ws && ws.readyState === WebSocket.OPEN && currentQueues && currentQueues.length > 0) {
                currentQueues.forEach((queue, index) => {
                    // Delay para no saturar el servidor
                    setTimeout(() => {
                        ws.send(JSON.stringify({
                            type: 'get_prediction',
                            queue_name: queue.name,
                            minutes_ahead: 10
                        }));
                        addLog(`üîÆ Solicitando predicci√≥n para: ${queue.name}...`);
                    }, index * 500);
                });
                addAlert('prediction', 'Predicciones M√∫ltiples', `Solicitando predicci√≥n para ${currentQueues.length} colas...`);
            } else {
                addAlert('anomaly', 'Error', 'No hay conexi√≥n o no hay colas disponibles');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            connectWebSocket();
            addLog('üöÄ Dashboard inicializado');
        });
    </script>
</body>
</html>
